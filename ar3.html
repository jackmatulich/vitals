<!DOCTYPE html>
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>AR Ultrasound Probe</title>
	<!-- include three.js library -->
	<script src="https://stemkoski.github.io/AR-Examples/vendor/three.js/build/three.min.js"></script>
	<!-- include jsartookit -->
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/build/artoolkit.min.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/build/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-artoolkitsource.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-artoolkitcontext.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-arbasecontrols.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-armarkercontrols.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/three.js/examples/js/loaders/GLTFLoader.js"></script>
	<style>
		body {
			margin: 0px;
			overflow: hidden;
			font-family: Monospace;
		}
		.control-panel {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			background-color: rgba(0, 0, 0, 0.7);
			color: white;
			padding: 10px;
			z-index: 999;
		}
		.slider-group {
			display: flex;
			align-items: center;
			margin: 5px 0;
		}
		.slider-label {
			width: 100px;
			margin-right: 10px;
		}
		.slider {
			flex-grow: 1;
		}
		.value-display {
			width: 60px;
			text-align: right;
			margin-left: 10px;
		}
		h3 {
			margin: 5px 0;
		}
		#status-msg {
			position: fixed;
			top: 10px;
			width: 100%;
			background-color: rgba(0,0,0,0.7);
			color: white;
			text-align: center;
			padding: 5px;
			z-index: 100;
		}
	</style>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

<div id="status-msg">Loading AR system...</div>

<div class="control-panel">
	<h3>Ultrasound Probe Controls</h3>
	
	<div class="slider-group">
		<div class="slider-label">Position X</div>
		<input type="range" min="-3" max="3" step="0.1" value="0.2" class="slider" id="posX">
		<div class="value-display" id="posXValue">0.2</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Position Y</div>
		<input type="range" min="-3" max="3" step="0.1" value="0" class="slider" id="posY">
		<div class="value-display" id="posYValue">0</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Position Z</div>
		<input type="range" min="-3" max="3" step="0.1" value="0" class="slider" id="posZ">
		<div class="value-display" id="posZValue">0</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Rotation X</div>
		<input type="range" min="0" max="360" step="1" value="90" class="slider" id="rotX">
		<div class="value-display" id="rotXValue">90</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Rotation Y</div>
		<input type="range" min="0" max="360" step="1" value="180" class="slider" id="rotY">
		<div class="value-display" id="rotYValue">180</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Rotation Z</div>
		<input type="range" min="0" max="360" step="1" value="0" class="slider" id="rotZ">
		<div class="value-display" id="rotZValue">0</div>
	</div>
	
	<div class="slider-group">
		<div class="slider-label">Scale</div>
		<input type="range" min="1" max="100" step="1" value="40" class="slider" id="scale">
		<div class="value-display" id="scaleValue">40</div>
	</div>
</div>

<script>

var scene, camera, renderer, clock, deltaTime, totalTime;

var arToolkitSource, arToolkitContext;

var patternArray, markerRootArray, markerGroupArray;
var probeGroup; // Contains the ultrasound probe model
var probeModel; // The actual GLB model

initialize();
animate();

function initialize()
{
	scene = new THREE.Scene();

	let ambientLight = new THREE.AmbientLight( 0xcccccc, 0.5 );
	scene.add( ambientLight );
				
	camera = new THREE.Camera();
	scene.add(camera);

	renderer = new THREE.WebGLRenderer({
		antialias : true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0)
	renderer.setSize( 640, 480 );
	renderer.domElement.style.position = 'absolute'
	renderer.domElement.style.top = '0px'
	renderer.domElement.style.left = '0px'
	document.body.appendChild( renderer.domElement );

	clock = new THREE.Clock();
	deltaTime = 0;
	totalTime = 0;
	
	////////////////////////////////////////////////////////////
	// setup arToolkitSource
	////////////////////////////////////////////////////////////

	arToolkitSource = new THREEx.ArToolkitSource({
		sourceType : 'webcam',
	});

	function onResize()
	{
		arToolkitSource.onResize()	
		arToolkitSource.copySizeTo(renderer.domElement)	
		if ( arToolkitContext.arController !== null )
		{
			arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)	
		}	
	}

	arToolkitSource.init(function onReady(){
		onResize()
		document.getElementById('status-msg').innerHTML = 'Camera initialized. Looking for cube marker...';
	});
	
	// handle resize event
	window.addEventListener('resize', function(){
		onResize()
	});
	
	////////////////////////////////////////////////////////////
	// setup arToolkitContext
	////////////////////////////////////////////////////////////	

	// create atToolkitContext
	arToolkitContext = new THREEx.ArToolkitContext({
		cameraParametersUrl: 'https://stemkoski.github.io/AR-Examples/data/camera_para.dat',
		detectionMode: 'mono'
	});
	
	// copy projection matrix to camera when initialization complete
	arToolkitContext.init( function onCompleted(){
		camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
		document.getElementById('status-msg').innerHTML = 'AR system initialized. Looking for cube marker...';
	});

	////////////////////////////////////////////////////////////
	// setup markerRoots
	////////////////////////////////////////////////////////////

	markerRootArray = [];
	markerGroupArray = [];
	patternArray = ["letterA", "letterB", "letterC", "letterD", "letterF", "kanji"];
	
	let rotationArray = [
		new THREE.Vector3(-Math.PI/2, 0, 0),
		new THREE.Vector3(0, -Math.PI/2, Math.PI/2),
		new THREE.Vector3(Math.PI/2, 0, Math.PI),
		new THREE.Vector3(-Math.PI/2, Math.PI/2, 0),
		new THREE.Vector3(Math.PI, 0, 0),
		new THREE.Vector3(0, 0, 0)
	];
		
	for (let i = 0; i < 6; i++)
	{
		let markerRoot = new THREE.Group();
		markerRootArray.push(markerRoot);
		scene.add(markerRoot);
		let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
			type: 'pattern',
			patternUrl: "https://stemkoski.github.io/AR-Examples/data/" + patternArray[i] + ".patt",
		});
	
		let markerGroup = new THREE.Group();
		markerGroupArray.push(markerGroup);
		markerGroup.position.y = -1.25/2;
		markerGroup.rotation.setFromVector3(rotationArray[i]);
		
		markerRoot.add(markerGroup);
	}
	
	////////////////////////////////////////////////////////////
	// setup probe model
	////////////////////////////////////////////////////////////
	
	probeGroup = new THREE.Group();
	// Scale the model appropriately (similar to how the example scales the cube)
	probeGroup.scale.set(1.25/2, 1.25/2, 1.25/2);
	
	// Add directional light
	let pointLight = new THREE.PointLight(0xffffff, 1, 50);
	pointLight.position.set(0.5, 3, 2);
	scene.add(pointLight);
	
	// Load the ultrasound probe model
	let loader = new THREE.GLTFLoader();
	loader.load('https://cdn.tinyglb.com/models/2ff293225d4a4ef3878d6a631fce6dbc.glb', function(gltf) {
		probeModel = gltf.scene;
		
		// Apply initial transformations
		probeModel.position.set(0.2, 0, 0);
		probeModel.rotation.set(
			90 * Math.PI/180,
			180 * Math.PI/180,
			0
		);
		probeModel.scale.set(40, 40, 40);
		
		probeGroup.add(probeModel);
		
		document.getElementById('status-msg').innerHTML = 'Model loaded. Show any side of the cube marker.';
		
		// Setup slider controls
		setupSliderControls();
	});
}

function setupSliderControls() {
	// Position X slider
	document.getElementById('posX').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.x = value;
		}
		document.getElementById('posXValue').textContent = value.toFixed(1);
	});
	
	// Position Y slider
	document.getElementById('posY').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.y = value;
		}
		document.getElementById('posYValue').textContent = value.toFixed(1);
	});
	
	// Position Z slider
	document.getElementById('posZ').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.z = value;
		}
		document.getElementById('posZValue').textContent = value.toFixed(1);
	});
	
	// Rotation X slider
	document.getElementById('rotX').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.x = radians;
		}
		document.getElementById('rotXValue').textContent = value;
	});
	
	// Rotation Y slider
	document.getElementById('rotY').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.y = radians;
		}
		document.getElementById('rotYValue').textContent = value;
	});
	
	// Rotation Z slider
	document.getElementById('rotZ').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.z = radians;
		}
		document.getElementById('rotZValue').textContent = value;
	});
	
	// Scale slider
	document.getElementById('scale').addEventListener('input', function() {
		const value = parseInt(this.value);
		if (probeModel) {
			probeModel.scale.set(value, value, value);
		}
		document.getElementById('scaleValue').textContent = value;
	});
}

function update()
{
	// update artoolkit on every frame
	if (arToolkitSource.ready !== false)
		arToolkitContext.update(arToolkitSource.domElement);
	
	// Check if any marker is visible
	let markerVisible = false;
	
	for (let i = 0; i < 6; i++)
	{
		if (markerRootArray[i].visible)
		{
			// Move the probe model to this marker
			markerGroupArray[i].add(probeGroup);
			markerVisible = true;
			
			// Update status message
			const statusMsg = document.getElementById('status-msg');
			if (statusMsg && statusMsg.style.display !== 'none') {
				statusMsg.innerHTML = "Marker " + patternArray[i] + " detected. Showing ultrasound probe.";
				statusMsg.style.backgroundColor = 'rgba(0, 128, 0, 0.7)';
				
				// Hide message after 3 seconds
				setTimeout(function() {
					statusMsg.style.display = 'none';
				}, 3000);
			}
			
			break;
		}
	}
	
	// If no marker is visible, show status message
	if (!markerVisible) {
		const statusMsg = document.getElementById('status-msg');
		if (statusMsg && statusMsg.style.display === 'none') {
			statusMsg.style.display = 'block';
			statusMsg.innerHTML = "Marker lost. Please show any side of the cube marker.";
			statusMsg.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
		}
	}
}


function render()
{
	renderer.render(scene, camera);
}


function animate()
{
	requestAnimationFrame(animate);
	deltaTime = clock.getDelta();
	totalTime += deltaTime;
	update();
	render();
}

</script>

</body>
</html>