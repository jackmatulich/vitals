<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>AR Ultrasound Probe with Cube Marker</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- Exactly the same libs as magic-cube example -->
	<script src="https://stemkoski.github.io/AR-Examples/vendor/three.js/build/three.min.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/three.js/examples/js/libs/stats.min.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/build/artoolkit.min.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-artoolkitsource.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/build/artoolkit.api.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-artoolkitcontext.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-arbasecontrols.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/ar.js/js/threex/threex-armarkercontrols.js"></script>
	<script src="https://stemkoski.github.io/AR-Examples/vendor/three.js/examples/js/loaders/GLTFLoader.js"></script>
	
	<style>
		body {
			margin : 0px;
			overflow: hidden;
			font-family: Monospace;
		}
		.control-panel {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			background-color: rgba(0, 0, 0, 0.7);
			color: white;
			padding: 10px;
			z-index: 999;
		}
		.slider-group {
			display: flex;
			align-items: center;
			margin: 5px 0;
		}
		.slider-label {
			width: 100px;
			margin-right: 10px;
		}
		.slider {
			flex-grow: 1;
		}
		.value-display {
			width: 60px;
			text-align: right;
			margin-left: 10px;
		}
		h3 {
			margin: 5px 0;
		}
		#status-msg {
			position: fixed;
			top: 10px;
			width: 100%;
			background-color: rgba(0,0,0,0.7);
			color: white;
			text-align: center;
			padding: 5px;
			z-index: 100;
		}
	</style>
</head>

<body>
	<div id="status-msg">Looking for cube marker from magic-cube example...</div>
	
	<div class="control-panel">
		<h3>Ultrasound Probe Controls</h3>
		
		<div class="slider-group">
			<div class="slider-label">Position X</div>
			<input type="range" min="-3" max="3" step="0.1" value="0.2" class="slider" id="posX">
			<div class="value-display" id="posXValue">0.2</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Position Y</div>
			<input type="range" min="-3" max="3" step="0.1" value="0" class="slider" id="posY">
			<div class="value-display" id="posYValue">0</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Position Z</div>
			<input type="range" min="-3" max="3" step="0.1" value="0" class="slider" id="posZ">
			<div class="value-display" id="posZValue">0</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Rotation X</div>
			<input type="range" min="0" max="360" step="1" value="90" class="slider" id="rotX">
			<div class="value-display" id="rotXValue">90</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Rotation Y</div>
			<input type="range" min="0" max="360" step="1" value="180" class="slider" id="rotY">
			<div class="value-display" id="rotYValue">180</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Rotation Z</div>
			<input type="range" min="0" max="360" step="1" value="0" class="slider" id="rotZ">
			<div class="value-display" id="rotZValue">0</div>
		</div>
		
		<div class="slider-group">
			<div class="slider-label">Scale</div>
			<input type="range" min="1" max="100" step="1" value="40" class="slider" id="scale">
			<div class="value-display" id="scaleValue">40</div>
		</div>
	</div>

<script>
// Global variables - exactly like magic-cube example
var scene, camera, renderer, clock, deltaTime, totalTime;
var arToolkitSource, arToolkitContext;
var markerRoot1;
var probeModel;

// Initialize everything
initialize();
animate();

function initialize() {
	// Create scene and camera - exactly like magic-cube example
	scene = new THREE.Scene();
	
	camera = new THREE.Camera();
	scene.add(camera);
	
	// Create renderer
	renderer = new THREE.WebGLRenderer({
		antialias: true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0);
	renderer.setSize(640, 480);
	renderer.domElement.style.position = 'absolute';
	renderer.domElement.style.top = '0px';
	renderer.domElement.style.left = '0px';
	document.body.appendChild(renderer.domElement);
	
	// Create clock for timing
	clock = new THREE.Clock();
	deltaTime = 0;
	totalTime = 0;
	
	// Initialize AR toolkit source (webcam)
	arToolkitSource = new THREEx.ArToolkitSource({
		sourceType: 'webcam',
	});
	
	arToolkitSource.init(function onReady() {
		// Resize everything once source is initialized
		onResize();
		
		// Update status message
		document.getElementById('status-msg').innerHTML = 'Camera initialized. Looking for cube marker...';
	}, function onError() {
		// Show error message
		document.getElementById('status-msg').innerHTML = 'ERROR: Could not initialize camera. Please check permissions.';
	});
	
	// Handle resize
	window.addEventListener('resize', function() {
		onResize();
	});
	
	function onResize() {
		arToolkitSource.onResizeElement();
		arToolkitSource.copyElementSizeTo(renderer.domElement);
		
		if (arToolkitContext && arToolkitContext.arController !== null) {
			arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
		}
	}
	
	// Initialize AR toolkit context
	arToolkitContext = new THREEx.ArToolkitContext({
		cameraParametersUrl: 'https://stemkoski.github.io/AR-Examples/data/camera_para.dat',
		detectionMode: 'mono',
		maxDetectionRate: 30,
		canvasWidth: 640,
		canvasHeight: 480,
	});
	
	arToolkitContext.init(function onCompleted() {
		// Copy projection matrix to camera
		camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		
		document.getElementById('status-msg').innerHTML = 'AR system initialized. Looking for cube marker...';
	});
	
	// Create marker root
	markerRoot1 = new THREE.Group();
	scene.add(markerRoot1);
	
	// Setup marker controls with the EXACT SAME marker as magic-cube example
	var markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
		type: 'pattern', 
		patternUrl: "https://stemkoski.github.io/AR-Examples/data/kanji.patt"
	});
	
	// Add ambient light
	var ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
	scene.add(ambientLight);
	
	// Add directional light
	var directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
	directionalLight.position.set(0, 0, 2);
	scene.add(directionalLight);
	
	// Load the ultrasound probe model instead of creating a cube
	var loader = new THREE.GLTFLoader();
	loader.load('https://cdn.tinyglb.com/models/2ff293225d4a4ef3878d6a631fce6dbc.glb', function(gltf) {
		probeModel = gltf.scene;
		
		// Apply initial transformations
		probeModel.position.set(0.2, 0, 0);
		probeModel.rotation.set(
			90 * Math.PI/180,
			180 * Math.PI/180,
			0
		);
		probeModel.scale.set(40, 40, 40);
		
		markerRoot1.add(probeModel);
		
		document.getElementById('status-msg').innerHTML = 'Model loaded. Show the kanji marker from magic-cube example.';
	});
	
	// Setup slider controls
	setupSliderControls();
}

function setupSliderControls() {
	// Position X slider
	document.getElementById('posX').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.x = value;
		}
		document.getElementById('posXValue').textContent = value.toFixed(1);
	});
	
	// Position Y slider
	document.getElementById('posY').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.y = value;
		}
		document.getElementById('posYValue').textContent = value.toFixed(1);
	});
	
	// Position Z slider
	document.getElementById('posZ').addEventListener('input', function() {
		const value = parseFloat(this.value);
		if (probeModel) {
			probeModel.position.z = value;
		}
		document.getElementById('posZValue').textContent = value.toFixed(1);
	});
	
	// Rotation X slider
	document.getElementById('rotX').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.x = radians;
		}
		document.getElementById('rotXValue').textContent = value;
	});
	
	// Rotation Y slider
	document.getElementById('rotY').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.y = radians;
		}
		document.getElementById('rotYValue').textContent = value;
	});
	
	// Rotation Z slider
	document.getElementById('rotZ').addEventListener('input', function() {
		const value = parseInt(this.value);
		const radians = value * Math.PI/180;
		if (probeModel) {
			probeModel.rotation.z = radians;
		}
		document.getElementById('rotZValue').textContent = value;
	});
	
	// Scale slider
	document.getElementById('scale').addEventListener('input', function() {
		const value = parseInt(this.value);
		if (probeModel) {
			probeModel.scale.set(value, value, value);
		}
		document.getElementById('scaleValue').textContent = value;
	});
}

function update() {
	// Update AR toolkit
	if (arToolkitSource.ready !== false) {
		arToolkitContext.update(arToolkitSource.domElement);
		
		// Update status message based on marker visibility
		if (markerRoot1.visible && !markerRoot1.wasVisible) {
			document.getElementById('status-msg').innerHTML = 'Marker detected! Showing ultrasound probe model.';
			markerRoot1.wasVisible = true;
			
			// Hide message after 3 seconds
			setTimeout(function() {
				document.getElementById('status-msg').style.display = 'none';
			}, 3000);
		} else if (!markerRoot1.visible && markerRoot1.wasVisible) {
			document.getElementById('status-msg').style.display = 'block';
			document.getElementById('status-msg').innerHTML = 'Marker lost. Please show the kanji marker again.';
			markerRoot1.wasVisible = false;
		}
	}
}

function render() {
	renderer.render(scene, camera);
}

function animate() {
	requestAnimationFrame(animate);
	deltaTime = clock.getDelta();
	totalTime += deltaTime;
	update();
	render();
}
</script>
</body>
</html>